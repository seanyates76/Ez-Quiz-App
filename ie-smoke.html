<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EZ-Quiz Interactive Editor — Smoke Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0d10;--fg:#e9eef5;--edge:#2a2f36;--focus:#5aa3ff}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{font-size:1.25rem;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--edge);background:transparent;color:inherit;border-radius:999px;padding:.45rem .8rem;cursor:pointer}
    .btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .pill{border-radius:999px;background:#1a1e24;border:1px solid var(--edge);padding:.25rem .6rem;font-size:.85rem;opacity:.9}
    .split{display:inline-flex;border:1px solid var(--edge);border-radius:999px;overflow:hidden}
    .split .btn{border:0;border-right:1px solid var(--edge)}
    .hidden{display:none !important}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    textarea,pre{width:100%;min-height:160px;border:1px solid var(--edge);border-radius:12px;padding:.75rem;background:transparent;color:inherit}
    pre{white-space:pre-wrap}
    .mirror[data-empty="true"]::before{content:"Generate or paste MC|… lines to preview here.";opacity:.7;font-style:italic}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:.5rem 0}
    .ie-grid{display:grid;gap:.75rem}
    .ie-card{border:1px solid var(--edge);border-radius:12px;padding:.75rem;background:transparent}
    .ie-row{display:grid;grid-template-columns:120px 1fr;gap:.5rem;align-items:center}
    .ie-row > label{font-size:.9rem;opacity:.85}
    .ie-choices{display:grid;gap:.5rem;margin-top:.5rem}
    .ie-choice{display:grid;grid-template-columns: 1fr auto auto;gap:.5rem;align-items:center}
    .ie-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem;align-items:center}
    .ie-error{color:#ff7171;font-size:.9rem}
    .ok{color:#22c55e;font-size:.85rem}
    .muted{opacity:.7}
    input[type="text"], select{background:transparent;color:inherit;border:1px solid var(--edge);border-radius:8px;padding:.4rem .55rem}
    input[type="checkbox"]{transform:scale(1.1)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Interactive Editor — Smoke Test</h1>

    <div class="row">
      <label class="row" style="gap:.5rem">
        <input id="toggleInteractiveEditor" type="checkbox" />
        <span>Interactive Editor (beta)</span>
      </label>
      <span class="pill" id="stats">Questions: 0 • Valid: 0</span>
      <span class="muted">Use buttons below to add questions. Edits sync to Raw.</span>
    </div>

    <div id="interactiveEditor" class="hidden" aria-label="Interactive editor">
      <div class="toolbar">
        <div class="row">
          <button class="btn" data-ie-add="MC">+ Add MC</button>
          <button class="btn" data-ie-add="TF">+ Add True/False</button>
          <button class="btn" data-ie-add="YN">+ Add Yes/No</button>
        </div>
        <div class="row">
          <button class="btn" id="ieImport">Import from raw</button>
          <button class="btn" id="ieClear">Clear all</button>
        </div>
      </div>
      <div class="ie-grid" id="ieGrid"></div>
    </div>

    <div class="cols">
      <div>
        <h2 class="muted" style="font-size:1rem">Raw Editor</h2>
        <textarea id="editor" spellcheck="false" placeholder="MC|Prompt|A|B|C|D|1"></textarea>
      </div>
      <div>
        <h2 class="muted" style="font-size:1rem">Mirror</h2>
        <pre id="generatedMirror" class="mirror" data-empty="true"></pre>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = (s,el=document)=>el.querySelector(s);
      const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
      const escapeHTML=(t='')=>String(t).replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','`':'&#96;'}[c]));

      const FLAG_KEY = 'ie_enabled_smoke';
      const toggle = $('#toggleInteractiveEditor');
      const mount  = $('#interactiveEditor');
      const grid   = $('#ieGrid');
      const editor = $('#editor');
      const mirror = $('#generatedMirror');
      const stats  = $('#stats');

      const ie = { enabled:false, questions:[] };

      // ---- Model <-> Parser ---------------------------------------------------
      function modelToParserLines(model){
        const lines = [];
        for (const q of model){
          if (q.type==='MC'){
            const choices = q.choices.map(s=>String(s||'').replace(/\|/g,'¦'));
            const correct = (q.correct||[]).map(i=>i+1).join(',') || '1';
            lines.push(['MC', String(q.prompt||'').replace(/\|/g,'¦'), ...choices, correct].join('|'));
          } else if (q.type==='TF'){
            const correct = (q.correct?.[0]===0) ? 'T' : 'F';
            lines.push(['TF', String(q.prompt||'').replace(/\|/g,'¦'), 'T','F', correct].join('|'));
          } else if (q.type==='YN'){
            const correct = (q.correct?.[0]===0) ? 'Y' : 'N';
            lines.push(['YN', String(q.prompt||'').replace(/\|/g,'¦'), 'Y','N', correct].join('|'));
          }
        }
        return lines.join('\n');
      }

      function parserTextToModel(text){
        const out=[]; const lines=String(text||'').split('\n').map(s=>s.trim()).filter(Boolean);
        for (const raw of lines){
          const parts = raw.split('|'); const kind=(parts[0]||'').toUpperCase();
          if (kind==='MC'){
            const prompt = parts[1]||'';
            const opts = parts.slice(2, -1);
            const corr = String(parts[parts.length-1]||'1').split(',').map(n=>Math.max(1,parseInt(n,10)||1)-1);
            out.push({ id:uid(), type:'MC', prompt, choices:opts, correct:corr });
          } else if (kind==='TF'){
            const prompt = parts[1]||''; const corr = (String(parts[4]||'T').toUpperCase()==='T') ? [0] : [1];
            out.push({ id:uid(), type:'TF', prompt, choices:['T','F'], correct:corr });
          } else if (kind==='YN'){
            const prompt = parts[1]||''; const corr = (String(parts[4]||'Y').toUpperCase()==='Y') ? [0] : [1];
            out.push({ id:uid(), type:'YN', prompt, choices:['Y','N'], correct:corr });
          }
        }
        return out;
      }

      function syncToRaw(){
        const raw = modelToParserLines(ie.questions);
        if (editor) editor.value = raw;
        if (mirror) { mirror.textContent = raw; mirror.dataset.empty = raw ? 'false' : 'true'; }
        updateStats();
      }
      function syncFromRaw(){
        ie.questions = parserTextToModel(editor.value);
        render();
        updateStats();
      }

      // ---- CRUD & helpers -----------------------------------------------------
      function uid(){ try{ return crypto.randomUUID(); } catch { return 'q_'+Math.random().toString(36).slice(2,9); } }
      function addQuestion(type='MC'){
        const base = { id:uid(), type, prompt:'', choices:[], correct:[] };
        if (type==='MC'){ base.choices=['Option A','Option B']; base.correct=[0]; }
        if (type==='TF'){ base.choices=['T','F']; base.correct=[0]; }
        if (type==='YN'){ base.choices=['Y','N']; base.correct=[0]; }
        ie.questions.push(base); render(); syncToRaw();
      }
      function delQuestion(id){ ie.questions = ie.questions.filter(q=>q.id!==id); render(); syncToRaw(); }
      function moveQuestion(id, dir){
        const i=ie.questions.findIndex(q=>q.id===id); if(i<0) return;
        const j=i+(dir==='up'?-1:1); if(j<0||j>=ie.questions.length) return;
        const [q]=ie.questions.splice(i,1); ie.questions.splice(j,0,q); render(); syncToRaw();
      }
      function setType(id, type){
        const q=ie.questions.find(x=>x.id===id); if(!q) return;
        q.type=type;
        if(type==='MC' && q.choices.length<2) { q.choices=['Option A','Option B']; q.correct=[0]; }
        if(type==='TF'){ q.choices=['T','F']; q.correct=[0]; }
        if(type==='YN'){ q.choices=['Y','N']; q.correct=[0]; }
        render(); syncToRaw();
      }
      function setPrompt(id, val){
        const q=ie.questions.find(x=>x.id===id); if(!q) return;
        q.prompt=val; validate(q,true); syncToRaw();
      }
      function addChoice(id){
        const q=ie.questions.find(x=>x.id===id); if(!q||q.type!=='MC') return;
        q.choices.push('New option'); validate(q,true); render(); syncToRaw();
      }
      function delChoice(id, idx){
        const q=ie.questions.find(x=>x.id===id); if(!q||q.type!=='MC') return;
        if(q.choices.length<=2) return;
        q.choices.splice(idx,1);
        q.correct = q.correct.filter(i=>i!==idx).map(i=> i>idx ? i-1 : i);
        render(); syncToRaw();
      }
      function setChoiceText(id, idx, text){
        const q=ie.questions.find(x=>x.id===id); if(!q) return;
        q.choices[idx]=text; validate(q,true); syncToRaw();
      }
      function toggleCorrect(id, idx){
        const q=ie.questions.find(x=>x.id===id); if(!q) return;
        if(q.type==='MC'){
          const p=q.correct.indexOf(idx); if(p>=0) q.correct.splice(p,1); else q.correct.push(idx);
          q.correct.sort((a,b)=>a-b);
        } else { q.correct=[idx]; }
        validate(q,true); render(); syncToRaw();
      }

      function validate(q, silent=false){
        const errs=[];
        if(!q.prompt.trim()) errs.push('Prompt is required.');
        if(q.type==='MC'){
          const nonEmpty=q.choices.filter(c=>String(c||'').trim());
          if(nonEmpty.length<2) errs.push('MC requires at least 2 options.');
          if(!q.correct.length) errs.push('Mark at least one correct option.');
          for(const i of q.correct) if(!nonEmpty[i]) errs.push('Correct index points to empty option.');
        }
        if((q.type==='TF'||q.type==='YN') && !q.correct.length) errs.push('Select the correct answer.');
        q._errors=errs; if(!silent) render(); return !errs.length;
      }

      function updateStats(){
        const total = ie.questions.length;
        const valid = ie.questions.reduce((n,q)=> n + (validate(q,true)?1:0), 0);
        stats.textContent = `Questions: ${total} • Valid: ${valid}`;
      }

      // ---- Render -------------------------------------------------------------
      function render(){
        grid.innerHTML='';
        mount.classList.toggle('hidden', !ie.enabled);
        ie.questions.forEach((q, idx)=>{
          const err=(q._errors&&q._errors[0])||'';
          const choicesHTML = (q.type==='MC'
            ? q.choices.map((c,i)=>`
              <div class="ie-choice">
                <input type="text" data-role="choice" data-index="${i}" value="${escapeHTML(c)}" aria-label="Choice ${i+1}">
                <label><input type="checkbox" data-role="correct" data-index="${i}" ${q.correct.includes(i)?'checked':''}> Correct</label>
                <button class="btn" data-role="delChoice" data-index="${i}" ${q.choices.length<=2?'disabled':''}>Remove</button>
              </div>
            `).join('')
            : `
              <div class="ie-choice">
                <label><input type="radio" name="yn-${q.id}" data-role="yn-correct" data-index="0" ${q.correct[0]===0?'checked':''}> ${q.type==='TF'?'True':'Yes'}</label>
              </div>
              <div class="ie-choice">
                <label><input type="radio" name="yn-${q.id}" data-role="yn-correct" data-index="1" ${q.correct[0]===1?'checked':''}> ${q.type==='TF'?'False':'No'}</label>
              </div>
            `);

          grid.insertAdjacentHTML('beforeend', `
            <div class="ie-card" data-id="${q.id}">
              <div class="ie-row">
                <label>Type</label>
                <div>
                  <select data-role="type">
                    <option value="MC" ${q.type==='MC'?'selected':''}>Multiple Choice</option>
                    <option value="TF" ${q.type==='TF'?'selected':''}>True / False</option>
                    <option value="YN" ${q.type==='YN'?'selected':''}>Yes / No</option>
                  </select>
                </div>
              </div>
              <div class="ie-row">
                <label>Prompt</label>
                <input type="text" data-role="prompt" value="${escapeHTML(q.prompt)}" placeholder="Enter the question prompt">
              </div>
              <div class="ie-row" style="align-items:start">
                <label>Answers</label>
                <div>
                  <div class="ie-choices">${choicesHTML}</div>
                  ${q.type==='MC' ? `<div class="ie-actions"><button class="btn" data-role="addChoice">+ Add choice</button></div>`:''}
                </div>
              </div>
              <div class="ie-actions">
                <button class="btn" data-role="moveUp" ${idx===0?'disabled':''}>Move up</button>
                <button class="btn" data-role="moveDown" ${idx===ie.questions.length-1?'disabled':''}>Move down</button>
                <button class="btn" data-role="delete">Delete</button>
                ${err?`<span class="ie-error" aria-live="polite">${escapeHTML(err)}</span>`:`<span class="ok">Looks good</span>`}
              </div>
            </div>
          `);
        });

        // wire per-card controls
        qsa('.ie-card', grid).forEach(card=>{
          const id = card.getAttribute('data-id');
          const q = ie.questions.find(x=>x.id===id); if(!q) return;

          card.querySelector('[data-role="type"]')?.addEventListener('change', e=> setType(id, e.target.value));
          card.querySelector('[data-role="prompt"]')?.addEventListener('input', e=> setPrompt(id, e.target.value));

          if (q.type==='MC'){
            qsa('[data-role="choice"]', card).forEach(inp=>{
              const idx = parseInt(inp.getAttribute('data-index'),10);
              inp.addEventListener('input', e=> setChoiceText(id, idx, e.target.value));
            });
            qsa('[data-role="correct"]', card).forEach(cb=>{
              const idx = parseInt(cb.getAttribute('data-index'),10);
              cb.addEventListener('change', ()=> toggleCorrect(id, idx));
            });
            qsa('[data-role="delChoice"]', card).forEach(btn=>{
              const idx = parseInt(btn.getAttribute('data-index'),10);
              btn.addEventListener('click', ()=> delChoice(id, idx));
            });
            card.querySelector('[data-role="addChoice"]')?.addEventListener('click', ()=> addChoice(id));
          } else {
            qsa('[data-role="yn-correct"]', card).forEach(r=>{
              const idx = parseInt(r.getAttribute('data-index'),10);
              r.addEventListener('change', ()=> toggleCorrect(id, idx));
            });
          }

          card.querySelector('[data-role="moveUp"]')?.addEventListener('click', ()=> moveQuestion(id,'up'));
          card.querySelector('[data-role="moveDown"]')?.addEventListener('click', ()=> moveQuestion(id,'down'));
          card.querySelector('[data-role="delete"]')?.addEventListener('click', ()=> delQuestion(id));
        });
      }

      // ---- Toggle + buttons ---------------------------------------------------
      function setEnabled(v){
        ie.enabled = v;
        localStorage.setItem(FLAG_KEY, v?'1':'0');
        mount.classList.toggle('hidden', !v);
        if (v && ie.questions.length===0) {
          // seed from raw if present
          ie.questions = parserTextToModel(editor.value);
        }
        render(); updateStats();
      }

      toggle.checked = (localStorage.getItem(FLAG_KEY) === '1');
      toggle.addEventListener('change', ()=> setEnabled(toggle.checked));

      document.querySelectorAll('[data-ie-add]').forEach(b=>{
        b.addEventListener('click', ()=> addQuestion(b.getAttribute('data-ie-add')));
      });
      document.getElementById('ieImport').addEventListener('click', ()=> { syncFromRaw(); });
      document.getElementById('ieClear').addEventListener('click', ()=> { ie.questions=[]; render(); syncToRaw(); });

      editor.addEventListener('input', ()=> { if (ie.enabled) syncFromRaw(); });

      // initial paint
      setEnabled(toggle.checked);
      syncToRaw();
    })();
  </script>
</body>
</html>

